[toc]

索引是对数据库表中一个或多个列的值进行排序的结构。
主要目的是提高 SQL Server 系统的性能，加快数据的查询速度和减少系统的相应时间。

## 索引的基本概念

数据的访问方式有两种：

- 使用表扫描访问数据。
- 使用索引扫描访问数据。

索引表是与基本表关联的一种数据结构，包含由基本表中的一列或多列生成的 **索引键** 和基本表中包含各个索引减的行所在的存储位置。
不管基本表中是否按索引键排序，索引中总是按索引键排序。

### 索引的优点和缺点

优点表现在以下几点：

- 通过创建唯一性索引，可以保证数据库表中每一行数据的唯一性。
- 可以大大加快数据的检索速度，这也是创建索引的最主要的原因。
- 可以加速表和表之间的链接，特别是在实现数据的参照完整性方面特别有意义。
- 在使用分组和排序子句进行数据检索时，同样可以显著减少查询中分组和排序的时间。
- 通过使用索引，可以在查询过程中使用优化隐藏器提高系统的性能。

缺点表现在以下几点：

- 创建索引和维护索引要消耗时间，除了数据表占用数据空间之外，每一格索引还要占用一定的物理空间。
- 当对表中的数据进行增加、删除和修改的时候，索引也要动态地维护，这样就降低了数据的维护速度。

### 索引的分类

#### 聚集索引和非聚集索引

- 聚集索引
	- 聚集索引会对基本表进行 **物理排序**。
	- 在每一张基本表中只能有一个聚集索引。
	- 当建立主键约束时，如果基本表中没有聚集索引，SQL Server 会将主键列作为聚集索引键。
- 非聚集索引
	- 非聚集索引不会对基本表进行物理排序。

#### 唯一索引和非唯一索引

- 唯一索引
	- 确保在被索引的列中，**所有的数据都是唯一的**，不包含重复的值。
	- 如果表具有 `PRIMARY KEY` 或 `UNIQUE` 约束时，在执行 `CREATE TABLE` 语句或 `ALTER TABLE` 语句时，SQL Server 会自动创建唯一索引。
- 非唯一索引
	- 允许所保存的列中出现重复的值。

#### 简单索引和复合索引

- 只针对基本表的一列建立的索引称为 **简单索引**。
- 针对多个列（最多包含 16 列）建立的索引称为 **复合索引** 或 **组合索引**。

## 创建索引

### 创建索引的基本原则

- 对一个表创建大量的索引，会影响 INSERT/UPDATE/DELETE 语句的性能，因此应避免对经常更新的表创建过多的索引。
- 若基本表的数据量大，且对基本表的更新操作较少而查询操作较多时，可以通过创建多个索引来提高性能。
- 当视图包含统计函数、表连接或两者组合时，在视图上创建索引可以显著地提高性能。
- 可以对唯一列或非空列创建聚集索引。
- 每个表只能创建一个聚集索引。
- 在包含大量重复值的列上创建索引，查询的时间胡较长。
- 若查询语句中存在计算列，则可以考虑对计算列值创建索引。
- 在实际创建索引时，要考虑索引大小的限制，即索引键最多包含 16 列，最大为 900 个字节。

### 使用 SSMS 图形化方式创建索引

略

### 使用 T-SQL 语句方式创建索引

```sql
CREATE [UNIQUE][CLUSTERED | NONCLUSTERED] INDEX <索引名>
ON <表名或视图名>(<列名> [ASC | DESC][, ..., n])
[WITH PAD_INDEX
[[,]FILLFACTOR = <填充因子>]
[, IGNORE_DUP_KEY]
[[,]DROP_EXISTING]
... ]
```

说明：

- UNIQUE：指定创建的索引为唯一索引。
	- 若省略此选项，则为非唯一索引。
- CLUSTERED | NONCLUSTERED：用于指定创建的索引为聚集索引或非聚集索引。
	- 若省略此选项，则创建的索引默认为非聚集索引。
- ASC | DESC：用于指定索引列升序或降序。
	- 默认设置为 ASC。
- PAD_INDEX：指定索引填充，取值为 ON 或 OFF。
	- 默认值为 OFF。
	- PAD_INDEX 选购想用来连接 FILLFACTOR，它指定在索引的中间级别页打开的自由空间特定的百分比。
- FELLFACTOR：指定填充因子的大小。
	- 使用 FELLFACTOR 是读与写之间的一个平衡操作。
- IGNORE_DUP_KEY：当向唯一聚集索引或唯一非聚集索引中插入重复数据时，忽略重复值的输入。
	- 此子句要和 UNIQUE 保留子同时使用。
- DROP_EXISTING：指定应删除并重新创建同名的之前存在的聚集索引或非聚集索引。

题目1：为课程表 C 的 CNAME 列创建名为 I_CNAME 的唯一索引。

```sql
create unique index I_CNAME
	on C(CNAME)
```

题目2：为选修课程表 SC 的 CNO、GRADE 列创建名为 I_CNO_GRADE 的复合索引。其中 CNO 为升序，GRADE 为降序。

```sql
create index I_CNO_GRADE
	on SC(CNO ASC, GRADE DESC)
```

### 间接创建索引

在定义或修改表结构时，如果定义了主键约束（PRIMARY KEY）或唯一性约束（UNIQUE），那么系统同时创建了索引。

> 索引一经创建，就完全由系统自动选择和维护，不需要用户指定使用索引，也不需要用户执行打开索引或进行重新索引等操作，所有的工作都是由 SQL Server 数据库管理系统自动完成的。

## 管理索引

索引需要定期管理，以提高空间的利用率。

### 查看与修改索引

#### 使用 SSMS 图形化方式查看与修改索引

略

#### 使用系统过程查看索引

```sql
[EXEC] sp_helpindex [@objname] <表名称>
```

用户也可以使用系统存储过程更改索引的名称。

```sql
[EXEC] sp_rename <表名>.<旧名称>, <新名称>[, <对象类型>]
```

### 删除索引

在删除索引之前，**必须先删除 PRIMARY KEY 或 UNIQUE 约束**。

#### 使用 SSMS 图形化方式删除索引

略

#### 使用 T-SQL 语句方式删除索引

```sql
DROP INDEX <表名>.<索引名>[, ..., n]
```

### 维护索引

- 检查整理索引碎片
	- 使用 T-SQL 的 DBCC SHOWCONTIG 语句检查相关表中有无索引的碎片信息。
		- `DBCC SHOWCONTIG(<表名>)`
	- 使用 DBCC INDEXDEFRAG 整理索引碎片。
		- `DBCC INDEXDEFRAG(<表名>,[<索引名>[,<填充因子>]])`
		- <索引名>：如果为 `''`，表示影响该表的所有索引。
		- <填充因子>：即索引页的数据填充程度。
- 重新组织索引

```sql
ALTER INDEX <索引名> | ALL
ON <表>
REBUILD
[WITH
([[,]PAD_INDEX = ON | OFF]
[[,]FILLFACTOR = <填充因子>]
[[,]sSORT_IN_TEMPDB = ON | OFF])]
```

其中，SORT_IN_TEMPDB = ON | OFF 专辑顶是否在 tempdb 中存储排序结果。默认值为 OFF

- 维护索引统计信息
	- 数据库选项 `AUTO_UPDATE_STATISTICS` 提供了统计信息自动更新功能。
	- 数据库选项 `AUTO_UPDATE_STATISTICS_ASYNC` 提供了统计信息异步更新功能。
	- 可以通过执行 `UPDATE STATISTICS` 语句手动更新统计信息。
