[toc]

SQL（Structured Query Language，结构化查询语言）之所以能够为用户和业界所接受，并成为国际标准，是因为它是一种综合的、功能极强同时又简单易学的语言。

## SQL 语言的发展与特点

### SQL 的发展历史

略

### SQL 语言的特点

- 高度非过程化
- 面向集合的操作方式
- 语法简单
- 关系数据库的标准语言

### 常用的 SQL 命令

分为三类

- 数据操纵语言 DML
	- **`SELECT`** 该语句对数据库中的数据进行检索。
	- **`INSERT`** 该语句向表中插入数据行。
	- **`UPDATE`** 该语句修改已经存在于表中的数据。
	- **`DELETE`** 该语句删除表中数据行。
- 数据定义语言 DDL
	- **`CREATE`** 该语句新建数据库对象。
	- **`ALTER`** 该语句更新已有数据对象的定义。
	- **`DROP`** 该语句删除已经存在的数据对象。
- 数据控制语言 DCL
	- **`GRANT`** 该语句用于授予权限。
	- **`REVOKE`** 该语句用于收回权限
	- **`COMMIT`** 该语句用于提交事务。
	- **`ROLLBACK`** 该语句用于回滚事务。

## Transact-SQL 简介

Transeact-SQL（简记 T-SQL）是 Microsoft 公司在关系数据库管理系统 SQL Server 中标准的 SQL 语言的具体实现，是微软对 SQL 的扩展。

- 具有 SQL 的主要特点。
- 增加了变量、运算符、函数、流程控制和注释等语言元素。

> T-SQL 对 SQL Server 十分重要，在 SQL Server 中使用图形界面能够完成的所有功能都可以利用 T-SQL 来实现。
  另一方面，尽管 SQL Server 提供了使用方便的图形化用户界面，但各种功能的实现基础是 T-SQL 语言。

> 在高级语言编写的应用程序中嵌入 T-SQL 可以完成所有的数据库管理工作。对于用户来说。T-SQL 是唯一可以和 SQL Server 的数据库管理系统进行交互的语言。

### 常用数据类型

在计算机中数据有类型和长度两种特征。
所谓数据类型就是以数据的表现方式和存储方式来划分的数据种类。

在 SQL Server 2008 中数据类型分为

- **精确数字**
- **近似数字**
- **日期和时间**
- **字符串**
- **Unicode 字符串**
- **二进制字符串**
- **其他数据类型**

#### 整数数据类型

|数据类型|范围|存储空间|
|-|-|-|
|`int`|-2<sup>31></sup> ~ (2<sup>31</sup> - 1)|4|
|`smallint`|-2<sup>15</sup> ~ (2<sup>15</sup> - 1)|2|
|`tinyint`|0 ~ 255|1|
|`bit`|1 / 0 / NULL|1|

#### 浮点数据类型

|数据类型|精确位数|范围|存储空间|
|-|-|-|
|`real`|7|-3.40 \* 10<sup>-38</sup> ~ 3.40 \* 10<sup>38</sup>|4|
|`float`|15|-1.79 \* 10<sup>-308</sup> ~ 1.79 \* 10<sup>308</sup>|8|

`float` 数据类型可写为 `float(n)`，其中 n 是 `float` 数据的 **精度**，为 1 ~ 53 的整数值。

#### 字符串数据类型

在使用字符数据类型时要加 **单引号 `''`**。

|数据类型|长度|描述|
|-|-|-|
|`char[(n)]`|**固定长度**，长度为 n 个字节，n 的取值为 1 ~ 8000 个 ANSI 字符。|若不指定 n 值，系统默认值为 1。<br />若输入数据的字符数小于 n，则系统自动用 **空格** 补齐。<br />若输入的数据过长，系统会自动截掉其超出部分。|
|`varchar[(n)]`|**可变长度**，n 的取值为 1~8000 个 **非 Unicode 字符**。|存储大小是输入数据的 **输入数据的字节的实际长度**。|
|`nvarchar[(n)]`|**可变长度**，n 的取值为 1~8000 个 **Unicode 字符**。|存储大小是输入数据的 **所输入字符个数的两倍**。|
|`text`|理论上是 1 ~ (2<sup>31</sup> - 1) 个字节。|用于存储大量文本数据。|

> ***所有用中括号 `[]` 围起的内容均为可选项。***

#### 日期和时间数据类型

|数据类型|存储格式|存储大小|存储范围|
|-|-|-|-|
|`date`|`YYYY-MM-DD`|3|0001-01-01 ~ 9999-12-31|
|`time`|`hh:mm:ss[.nnnnnnn]`|3 ~ 5|00:00:00.0000000 ~ 23:59:59.9999999|
|`datetime`|`YYYY-MM-DD hh:mm:ss[.nnnnnnn]`|8|1753-01-01 ~ 9999-12-31|

#### 货币数据类型

在使用货币数据类型是，应在数据前面加上 **货币符号 `$` `￥`** 等。

|数据类型|取值范围|存储空间|
|-|-|-|
|`money`|-2<sup>63</sup> ~ (2<sup>63</sup> - 1)|8|
|`smallmoney`|-2<sup>31</sup> ~ (2<sup>31</sup> -1)|4|

### 变量

T-SQL 中的变量分为 **全局变量** 和 **局部变量** 两类。

- 全局变量是由 SQL Server 系统定义和使用的变量，也成为 **系统变量**。
	- 名称前面加 **两个 `@`** 符号。
- 局部变量是用户自定义的变量，它的作用范围仅在程序内部。
	- 名称前面加 **一个 `@`** 符号。
	- 必须先用 **`DECLARE` 语句** 说明才可使用。
	- 语法：`DECLARE <@变量名> <变量类型>[,<@变量名> <变量类型> ...]`
- 在 T-SQL 中不能像在一般的程序语言中使用 `=` 赋值。
	- 使用 **`SELECT` 或 `SET` 语句** 来设定变量的值。
	- 语法：

```sql
SELECT <@局部变量> = <变量值>
SET <@局部变量> = <变量值>
```

### 输出语句 `PRINT`

`PRINT` 语句是向客户端返回一个用户自定义的信息，即显示一个字符串、局部变量或全局变量的内容。

- 语法
	- `PRINT <文本串> | <@局部变量> | <@@函数> | <字符串表达式>`
	- 说明：
		- <文本串>：用单引号引起来的汉字、字符或数字。
		- <@局部变量>：必须是任意有效的字符数据类型变量。
		- <@@函数>：返回字符串结果的函数。
		- <字符串表达式>：返回字符串的表达式，可包含用 **`+`** 连接的字符串或变量。

```sql
declare @x char(10)
set @x = 'LOVING'
print @x
print '最喜爱的歌曲是：' + @x
```

> `GO` 不是 T-SQL，是 SQL Server 查询分析器及一些使用工具执行一批 T-SQL 语句的结束命令。

### 常用运算符

#### 算术运算符

|运算符|含义|
|-|-|
|`+`|加法|
|`-`|减法|
|`*`|乘法|
|`/`|除法|
|`%`|求余数|

#### 比较运算符

比较运算符的结果是 **布尔数据类型**，它有 **TRUE / FALSE / UNKNOWN** 3 种值。

|运算符|含义|
|-|-|
|`=`|等于|
|`>`|大于|
|`<`|小于|
|`>=`|大于等于|
|`<=`|小于等于|
|`<>`|不等于|

#### 逻辑运算符

逻辑运算符的结果是 **布尔数据类型**，它有 **TRUE / FALSE** 3 种值。

|运算符|含义|
|-|-|
|`OR`|两个布尔表达式有一个为 TRUE，那么就为 TRUE。|
|`AND`|两个布尔表达式都为 TRUE，那么就为 TRUE。|
|`NOT`|对任何其他布尔运算符的值取反。|

#### 注释

注释也称为注解，是写在程序代码中的说明性文字。
注释内容不被系统编译，也不被程序执行。

- 单行注释 `--`
- 多行注释 `/*   */`

#### 常用系统函数

##### 字符串函数

|函数表达式|功能|举例|
|-|-|-|
|`SUBSTRING(表达式, 起始, 长度)`|取子串|`SUBSTRING('ABCDEFG', 3, 4)`|
|`RIGHT(表达式, 长度)`|右边取子串|`RIGHT('ABCDEF', 3)`|
|`STR(浮点数[, 总长度[, 小数位]])`|数值型转换字符型|`STR(234, 5678, 6, 2)`|
|`LTRIM`(表达式)` / `RTRIM(表达式)`|去左、右空格|`LTRIM(SNO)`，SNO 为字段名|
|`CHARINDEX(子串, 母串)`|返回子串起始位置|`CHARINDEX('AD', 'HAADYU')`|

##### 类型转换函数

|函数表达式|功能|举例|
|-|-|-|
|`CONVERT(数据类型[(长度)], 表达式[, 日期转字符串样式])`<sup>1</sup>|表达式类型转换|`CONVERT(varchar(100), GETDATE(), 1)`<br />当前日期转换为字符串|
|`CAST(表达式 AS 数据类型[(长度)])`|表达式类型转换|`CAST(23 AS nvarchar)`，数值转字符串|

注：
<sup>1</sup>：日期转换字符串样式有

|取值|样式|
|-|-|
|1|mm/dd/yy|
|5|dd-mm-yy|
|11|yy-mm-dd|
|23|yyyy-mm-dd|

##### 数值函数

|函数表达式|功能|举例|
|-|-|-|
|`ABS(表达式)`|取绝对值|`ABS(-17.2)`|
|`POWER(底, 指数)`|底的指数次方|`POWER(6, 2)`|
|`RAND([整型数])`|随机数产生器|`RAND(1)`|
|`ROUND(表达式, 精度)`|按精度四舍五入|`ROUND(24.2367, 2)`|
|`SQRT(表达式)`|算术平方根|`SQRT(10)`|

##### 日期函数

|函数表达式|功能|举例|
|-|-|-|
|`GETDATE()`|当前的日期和时间|`GETDATE()`|
|`DAY(表达式)`|表达式的日期值|`DAY(GETDATE())`|
|`MONTH(表达式)`|表达式的月份值|`MONTH(GETDATE())`|
|`YEAR(表达式)`|表达式的年份值|`YEAR(GETDATE())`|
|`DATEADD(标志, 间隔值, 日期)`<br />YY：年份，MM：月份，DD：日|日期间隔后的日期|`DATEADD(MM, 2, GETDATE())`,两个月后的日期|
|`DATEDIFF(标志, 日期1, 日期2)`|日期2 与 日期1 的差|`DATEDIFF(YY, BIRTHDAY, GETDATE())`,计算年龄|


##### 统计函数（参数默认 ALL)

|函数表达式|功能|举例|
|-|-|-|
|`AVG(ALL \ DISTINCT 列名)`|取均值|`AVG(AGE)`|
|`COUNT(ALL \ DISTINCT 列名)`|行数|`COUNT(DISTINCT AGE)`|
|`MAX(ALL \ DISTINCT 列名)`|最大值|`MAX(AGE)`|
|`MIN(ALL \ DISTINCT 列名)`|最小值|`MIN(AGE)`|
|`SUM(ALL \ DISTINCT 列名)`|总和|`SUM(AGE)`|
