[toc]

## 状态图的基本组成部分

**状态图** 描述了系统中一个对象所具有的各种状态和这个对象从一种状态到另一种状态的转换（迁移），以及影响对象这些状态的事件（如收到消息、时间已到、报错、条件为真）等。

### 对象状态的基本描述图符

- **状态**
    - 使用一个 **圆角矩形** 表示。
    - 状态图符的长式由 **状态名、状态变量和内部活动** 三个部分组成。
    - 状态图符的短式只写上状态名就可以了。
- **迁移**
    - **实线箭头** 表示，箭尾连接 **出发状态（源状态）**，箭头连接 **到达状态（目标状态）**。
- **起始状态**
    - 代表状态图的起始点，本身无状态。
    - 用一个 **实心圆** 表示。
- **结束状态**
    - 代表状态图的最后状态，本身无状态。
    - 用一个 **圆中套一个实心圆** 表示。
- **条件判定**
    - 条件判定是一个转折点，状态迁移按照满足条件的方向进行。
    - 用 **空心菱形** 表示。
    - 条件判定通常为 **一个入迁移**，**多个出迁移**。
- **并发执行**
    - 并发状态描述对象的同步工作状态。
    - 分为 **分劈** 和 **接合** 两种图符。
    - 由一条 **粗短实线** 表示，称为 **并发杆（同步杆）**。
- **信号图符**
    - 信号图符分别发出信号和接收信号。
    - 发出信号图符有一个一侧为 **凸尖角的矩形** 表示。
    - 接收信号图符由一个一侧为 **凹尖角的矩形** 表示。
    - **虚线箭头** 的箭头方向表示信号的传输方向。

![状态图的图符](http://oxnec2zdn.bkt.clouddn.com/UMLxitongjianmo/zhuangtaitudetufu.png)

状态图符的长式由 **状态名、状态变量和内部活动** 三个部分组成。

- 状态名
    - 在一个状态图中，状态名具有唯一性。
    - 可以有匿名状态名。
- 状态变量
    - 状态图所描述的类的属性。
    - 相应对象所接受的事件，给属性赋值。
    - 不改变对象自身的状态。
- 活动
    - 列出了在该状态时要执行的事件和动作。
    - **entry 事件**：指明进入该状态时的特定动作。
    - **exit 事件**：指明退出该状态时的特定动作。
    - **do 事件**：指明在该状态中执行的动作。
    - 可以是 **简单事件** 或 **组合事件**。
    - 基本语法：`事件名(参数表) / 动作表达式`。
        - 事件名：可以是包括三个标准事件在内的任何事件。
        - 动作表达式：执行的动作。
        - 参数表：表示该事件所需的参数。

![长式状态图符](http://oxnec2zdn.bkt.clouddn.com/UMLxitongjianmo/changshizhuangtaitufu.png)

### 状态的改变——迁移

一个对象的状态可以因某种原因而改变，一个对象从一个状态改变成另一个状态称为 **状态迁移**。

- 在状态图中，状态的迁移用连接这两个状态的 **实线箭头** 表示。
- 状态迁移线上可写上引起该迁移的事件、条件和动作。
- 当该事件出现时，该动作发生，执行从一个状态到另一个状态的迁移，称为 **迁移点火** 或 **迁移触发**。

引起状态迁移的原因通常有两种：

- 当出现某一事件时会引起状态的迁移，在状态图中把这种引起状态迁移的时间标在该箭头上。
    - 当处于源状态的对象接收到一个事件，并且满足当前条件（如果有条件）时，首先执行引起迁移的时间中的动作（如果有的话），然后迁移到新的状态，执行新状态中的内部动作。
        - *在执行 do 或用户定义的动作时，还可以被外部的事件中断。*
        - *而 entry 动作和 exit 动作不能被中断。*
        - 也就是说，**即使状态中的某个 do 或用户定义的动作被中断，仍要执行完 exit 动作后再迁移状态**。
- 当迁移线上 **没有标识触发迁移的事件** 时，则从源状态转换为目标状态 **自动进行**。

![状态图](http://oxnec2zdn.bkt.clouddn.com/UMLxitongjianmo/zhuangtaitu.png)

## 状态的分类与描述

对象的状态可以分为 **嵌套状态**、**顺序状态**、**历史状态**、**同步状态** 和  **并发状态**。

### 对象的状态属性

对于确定对象的状态有 **重要意义** 的属性称为 **状态属性**。

特征：

- 一般具有少量的可选值。
- 属性值的转换有一定的限制。

在 UML 中，状态属性是表示对象状态的机制。
**状态** 是表示对象在其生存期中的一种条件或状况。

### 简单状态与嵌套状态

在一个状态图的活动区还画有一个或多个状态图，称为 **嵌套状态**。

- 被嵌套的状态称为 **子状态**。
- 一个子状态还可以有自己的嵌套状态。

**不含嵌套状态** 的状态称为 **简单状态**。

- 简单状态对应一个动作，而嵌套状态中每个被嵌套的状态图都对应于该嵌套状态内正在进行的一个活动。

在 UML 中，动作和活动的含义是不同的。

- **动作** 指一组可执行的语句，且具有以下特征：
    - 迁移性
    - 原子性
    - 连续性
- **活动** 指一组可执行的动作，且具有以下特征：
    - 有限性
    - 非原子性

在一个嵌套状态中，被嵌套的子状态图中必须有自己的起始状态和结束状态。

- 在状态迁移中，一个嵌套状态的入迁移就是其子状态图的起始状态的入迁移。
- 其子状态图的结束状态的迁移表示该嵌套状态的相应活动的结束。

嵌套状态内的多个子状态可以是 "并" 关系的子状态或者是 "或" 关系的子状态。

- 或关系子状态表示在任意时刻这些子状态中只有一个子状态是活动的。
- 并关系子状态表示在同一时刻有多个子状态是活动的。

### 状态的顺序迁移

**顺序状态** 表示状态的顺序迁移，也称为 **"不相交状态"**。
表明状态图中的状态没有并发迁移现象，状态之间的迁移是串行的。

![状态的顺序迁移](http://oxnec2zdn.bkt.clouddn.com/UMLxitongjianmo/zhuangtaideshunxuqianyi.png)

### 状态的并发迁移与同步

一个状态可以有多个并发的子状态。

- 并发子状态之间用 **虚线** 分隔，用虚线分割的每个区域表示一个并发的子状态。
- 虚线具有一个名字（任选），并有一个内部的状态图。

![状态的并发迁移](http://oxnec2zdn.bkt.clouddn.com/UMLxitongjianmo/zhuangtaidebingfaqianyi.png)

**复合迁移** 就是由条件判定、并发分劈和并发接合这些图符将一些简单迁移组合而成的迁移。

- 一个同步并发迁移图符用一个短而粗的线条表示，称为 **同步杆**。

![复合迁移](http://oxnec2zdn.bkt.clouddn.com/UMLxitongjianmo/fuheqianyi.png)

### 嵌套状态中的历史状态指示器

**历史指示器** 用来记忆状态图内部的历史状态。
用 **里面标有 H 字母的圆圈** 表示。

- 历史指示器作用于标有它的子状态图。
- 如果指向历史指示器的迁移被触发，对象就会恢复到该状态区域当前状态的前一个状态。
- 历史指示器是一个伪状态，可以有几个进入它的状态迁移，但没有离开它的状态迁移。

![历史状态指示器](http://oxnec2zdn.bkt.clouddn.com/UMLxitongjianmo/lishizhuangtaizhishiqi.png)

## 状态迁移的触发与描述

### 状态的迁移触发

状态迁移触发表示当一个特定的事件发生或某些条件满足时，一个源状态下的对象将完成一些特定的动作，称为 **迁移触发**。

- **活动状态**：迁移发生时，该迁移 **进入** 的状态为活动状态，它将执行相应的动作。
- **非活动状态**：迁移发生时，该迁移 **离开** 的状态为非活动状态。

描述状态迁移的形式化语法格式：
`事件 [条件] / 动作表达式 发送子句`

- 事件：指已发生并可能引起某种活动的一件事。
- [条件]：由方括号围起的关系或逻辑表达式。
- 动作表达式：一个触发状态迁移时可执行的过程表达式。
- 发送子句：动作的一个特例，说明调用的事件名（操作）是哪个对象的。

### 触发状态迁移的事件

**事件** 是指已发生并可能引发某种活动的一件事。

描述格式：`事件名(参数表)`

- 事件名：必须引用接收事件的对象类中的一个操作或信号。
- 参数表：传送给该事件的形式参数。

种类如下：

- **状态内部事件**
- **消息**
- **时间事件**

#### 状态内部事件

- **入口事件**
    - UML 提供的标准内部事件。
    - 用关键字 `entry` 说明。
    - 进入状态时最先执行的一个内部入口动作序列，不带条件。
    - 只在最高层状态图创建该类的对象时有参数，一般不带参数。
- **出口事件**
    - UML 提供的标准内部事件。
    - 用关键字 `exit` 说明。
    - 退出状态时执行的一个内部动作序列，不带条件和参数。
    - 不能中断，具有原子性，为隐式调用。
- **do 事件**
    - 在入口事件之后，出口事件之前执行的内部一个动作序列。
    - 可以中断。
    - 引用的是嵌套子状态图的全部动作序列。
- **include 事件**
    - 在入口事件之后，出口时间之前执行。
    - 标识一个嵌套子状态图的引用，其动作表达式中包含该子状态图的名字。
- **自定义内部事件**
    - 根据需要自定义的事件。
    - 不引起状态迁移。

#### 消息

- **调用事件**
    - 对象之间，一个对象请求调用另一个对象的操作。
    - 标在迁移线上。
    - 可以是同步调用，可以是异步调用。
- **信号事件**
    - 用发出信号图符和接收信号图符表示信号事件。
    - 发出信号图符表名发送子句，接收信号图符含有事件名称。

#### 时间事件

- **after 事件**
    - 格式：`after(时间表达式) / 动作`
    - `/` 后跟有动作。
    - 括号内的时间表达式为真式，执行后面的动作，触发状态的迁移。
- **defer 事件**
    - 延迟事件的标记格式：`事件名 / defer`
    - 延迟事件是在本状态中不进行处理，而将其推迟到下一个状态进行处理事件，或将事件放进队列中排队。
- **when 事件**
    - 改变事件的表示格式：`when(逻辑表达式) / 动作`
    - 当括号内的逻辑表达式为真时，执行后面的动作，触发状态的迁移。

![触发迁移的事件](http://oxnec2zdn.bkt.clouddn.com/UMLxitongjianmo/chufaqianyideshijian.png)

> 使用构造型 `<<error>>` 标记出错事件名。

### 触发状态迁移的条件和动作表达式

**条件** 是一个由方括号围起的关系或逻辑表达式。

- 如果状态迁移中既有事件又有条件，则表示仅当这个事件发生并且条件为真时相应的状态迁移才被触发。
- 如果状态迁移上只有条件时，表示在该条件为真时，触发状态迁移。

**动作表达式** 是一个触发状态迁移时可执行的过程表达式。

- 表达式中可以引用该状态所表示的对象中的属性、操作，或者事件中的参数。
- 一个状态迁移上可以有多个动作表达式，但必须用 `/` 分隔。

### 状态迁移的分类

- **自迁移**
    - 源状态和目标状态为同一状态的迁移。
    - *自迁移中有入口事件和出口事件，分别调用状态的入口动作和出口动作*。
- **内部迁移**
    - 该迁移在状态内部进行，不引起状态变化。
    - *内部迁移不调用状态的入口动作和出口动作*。
    - 由标准内部事件或用户自定义的内部事件引发。
- **自动迁移**
    - 在迁移线上没有条件和出发事件。
    - 当一个状态完成时，自动触发迁移，进入下一个状态。
- **复合迁移**
    - 由条件判定、并发分劈和并发接合将一些简单迁移组合而成。

### 状态图之间的通信联系

使用 **动作** 或状态图之间的 **带箭头的虚线** 来表示状态图向其他状态图发送的消息。

在状态图之间画表示消息的箭头线可以有两种画法：

- 从表示源对象状态图中的状态迁移上画虚线到表示目标对象状态图的边框上。
    - 此时，在目标对象状态图中应画有一个捕获这个消息的相应的迁移。
- 在两个状态图的边框间（即两个对象间）画虚线，表示源对象在其执行期间的某时刻发送消息。
    - 此时，在目标对象状态图中也必须有一相应的迁移，以捕获该消息。

## 活动图与状态图的比较

### 状态图与活动图的相同点

- 描述图符基本一样。
    - 活动的图符由两边半圆边线的矩形表示，状态的图符由圆角矩形表示。
    - 其余的描述图符完全相同。
- 可以描述一个系统或对象在生存期间的状态或行为。
- 可以描述一个系统或对象在多进程才做中的同步与异步操作的并发行为。
- 可以用条件分支图符描述一个系统或对象的行为控制流。

### 状态图与活动图的不同点

- 触发一个系统或对象的状态（活动）发生迁移的机制不同。
    - 状态图中的对象状态要发生迁移，**必须有一个可以触发状态迁移的事件发生，或有一个满足了触发状态迁移的条件产生**。
    - 活动图中的活动状态迁移不需要事件触发，**一个活动执行完毕可以直接进入下一个活动状态**。
- 描述多个对象共同完成一个操作的机制不同。
    - 状态图一般用来描述 **一个系统或某个对象** 在生存期的行为、所经历的状态序列、引起状态转移的事件以及因状态转移而引起的动作。
    - 活动图通过采用建立泳道的方式来描述 **一个系统中几个对象** 共同完成一个操作或一个用例实例（场景）所需要的活动。
